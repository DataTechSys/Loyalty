<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Settings · Loyalty Console</title>
        <!-- Inter font + Bootstrap (same as other pages) -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
    :root{
      --dt-bg:#f3f5f9; --dt-card:#ffffff; --dt-text:#0f172a; --dt-muted:#6b7280;
      --dt-primary:#1f6feb; --dt-border:#e5e7eb; --dt-radius-lg:16px;
      --dt-shadow:0 8px 24px rgba(15,23,42,.06);
    }
    html,body{height:100%}
    body{
      background:var(--dt-bg); color:var(--dt-text);
      font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Top bar */
    .dt-topbar{ background:var(--dt-card); border-bottom:1px solid var(--dt-border); position:sticky; top:0; z-index:1030; }
    .dt-brand{ display:flex; align-items:center; gap:.65rem; font-weight:600; }
    .dt-brand img{ width:22px; height:22px; border-radius:6px; }

    /* Page */
    .dt-page{ padding:28px 0 56px; }

    /* Cards */
    .dt-card{
      background:var(--dt-card); border:1px solid var(--dt-border);
      border-radius:var(--dt-radius-lg); box-shadow:var(--dt-shadow);
    }
    .section-title{ font-weight:700; letter-spacing:-.02em; }

    .form-control, .form-select{ border-radius:12px; }
    .btn{ border-radius:12px; }
    .btn-primary{
      --bs-btn-bg: var(--dt-primary); --bs-btn-border-color: var(--dt-primary);
      --bs-btn-hover-bg:#1b5ed1; --bs-btn-hover-border-color:#1b5ed1;
      --bs-btn-active-bg:#184fb3; --bs-btn-active-border-color:#184fb3;
      --bs-btn-shadow:0 8px 18px rgba(31,111,235,.25);
    }
    .text-muted{ color: var(--dt-muted) !important; }

    .logo-preview{
      width:64px;height:64px;border-radius:12px;border:1px solid var(--dt-border);
      display:grid;place-items:center;background:#fff;overflow:hidden;
    }
    .logo-preview img{ max-width:100%; max-height:100%; object-fit:contain; }

    /* Small helpers */
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
          background:#f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; }
  </style>
    </head>
    <body>
        <!-- Top Bar -->
        <nav class="dt-topbar py-2">
            <div class="container d-flex align-items-center justify-content-between">
                <div class="dt-brand">
                    <img src="images/DataTech.png" alt="DataTech"><span>Loyalty Console</span>
                </div>
                <div class="d-flex align-items-center gap-2"><a href="dashboard.html" class="btn btn-outline-secondary btn-sm">Dashboard</a><a href="members.html" class="btn btn-outline-secondary btn-sm">Customers</a><a href="messages.html" class="btn btn-outline-secondary btn-sm">Messages</a>
                    <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
                </div>
            </div>
        </nav>
        <!-- Page -->
        <main class="dt-page">
            <div class="container">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h1 class="h4 section-title mb-0">Settings</h1><small class="text-muted">Company branding, integrations & security</small>
                </div>
                <form id="settingsForm" novalidate>
                    <div class="row g-3">
                        <!-- Branding -->
                        <div class="col-12 col-lg-6">
                            <div class="dt-card p-3 p-md-4 h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h2 class="h6 mb-0">Branding</h2><span class="text-muted small">Shown in Console & Wallet</span>
                                </div>
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="logo-preview" id="logoPreview">
                                        <img id="logoImg" src="images/DataTech.png" alt="Logo">
                                    </div>
                                    <div class="flex-grow-1">
                                        <label class="form-label fw-semibold">Logo URL</label>
                                        <input type="url" id="branding.logoUrl" class="form-control" placeholder="https://…/logo.png">
                                        <div class="form-text">Paste a public image URL (PNG/SVG/JPG). Shown at 64×64.</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Company Display Name</label>
                                    <input type="text" id="branding.displayName" class="form-control" placeholder="Your brand name">
                                </div>
                                <div class="row g-2">
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Primary Color</label>
                                        <input type="color" id="branding.primaryColor" class="form-control form-control-color" value="#1f6feb" title="Choose color">
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Accent Color</label>
                                        <input type="color" id="branding.accentColor" class="form-control form-control-color" value="#10b981" title="Choose color">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Company -->
                        <div class="col-12 col-lg-6">
                            <div class="dt-card p-3 p-md-4 h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h2 class="h6 mb-0">Company</h2><span class="text-muted small">Tenant info & locale</span>
                                </div>
                                <div class="row g-2">
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Account / Tenant ID</label>
                                        <input type="text" id="company.tenantId" class="form-control" placeholder="e.g. koobs">
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Timezone</label>
                                        <select id="company.timezone" class="form-select">
                                            <option value="Asia/Kuwait">Asia/Kuwait (GMT+3)</option>
                                            <option value="UTC">UTC</option>
                                            <option value="Asia/Dubai">Asia/Dubai (GMT+4)</option>
                                            <option value="Europe/London">Europe/London</option>
                                            <option value="America/New_York">America/New_York</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-2 mt-1">
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Currency</label>
                                        <select id="company.currency" class="form-select">
                                            <option value="KWD">KWD — Kuwaiti Dinar</option>
                                            <option value="USD">USD — US Dollar</option>
                                            <option value="AED">AED — UAE Dirham</option>
                                            <option value="SAR">SAR — Saudi Riyal</option>
                                            <option value="EUR">EUR — Euro</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Locale</label>
                                        <select id="company.locale" class="form-select">
                                            <option value="en">English</option>
                                            <option value="ar">Arabic</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Integrations -->
                        <div class="col-12">
                            <div class="dt-card p-3 p-md-4">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h2 class="h6 mb-0">Integrations</h2><span class="text-muted small">Store credentials for APIs</span>
                                </div>
                                <div class="accordion" id="integrations">
                                    <!-- PassKit -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="passkit-head"> <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#passkit" aria-expanded="true" aria-controls="passkit">
                                                PassKit
</button> </h2>
                                        <div id="passkit" class="accordion-collapse collapse show" aria-labelledby="passkit-head" data-bs-parent="#integrations">
                                            <div class="accordion-body">
                                                <div class="row g-2">
                                                    <div class="col-12 col-md-6">
                                                        <label class="form-label fw-semibold">API Key</label>
                                                        <input type="password" id="integrations.passkit.apiKey" class="form-control" placeholder="pk_live_…">
                                                    </div>
                                                    <div class="col-12 col-md-6">
                                                        <label class="form-label fw-semibold">Template ID</label>
                                                        <input type="text" id="integrations.passkit.templateId" class="form-control" placeholder="tmpl_…">
                                                    </div>
                                                </div>
                                                <div class="form-text mt-1">Use this to send push & update wallet fields via PassKit.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Foodics -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="foodics-head"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#foodics" aria-expanded="false" aria-controls="foodics">
                                                Foodics
</button> </h2>
                                        <div id="foodics" class="accordion-collapse collapse" aria-labelledby="foodics-head" data-bs-parent="#integrations">
                                            <div class="accordion-body">
                                                <div class="row g-2">
                                                    <div class="col-12 col-md-4">
                                                        <label class="form-label fw-semibold">Branch ID</label>
                                                        <input type="text" id="integrations.foodics.branchId" class="form-control" placeholder="branch_…">
                                                    </div>
                                                    <div class="col-12 col-md-8">
                                                        <label class="form-label fw-semibold">API Token</label>
                                                        <input type="password" id="integrations.foodics.apiToken" class="form-control" placeholder="token_…">
                                                    </div>
                                                </div>
                                                <div class="form-text mt-1">Used for redemptions and sync with your POS.</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Twilio -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="twilio-head"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#twilio" aria-expanded="false" aria-controls="twilio">
                                                Twilio (OTP SMS)
</button> </h2>
                                        <div id="twilio" class="accordion-collapse collapse" aria-labelledby="twilio-head" data-bs-parent="#integrations">
                                            <div class="accordion-body">
                                                <div class="row g-2">
                                                    <div class="col-12 col-md-4">
                                                        <label class="form-label fw-semibold">Account SID</label>
                                                        <input type="text" id="integrations.twilio.sid" class="form-control" placeholder="ACxxxxxxxxx">
                                                    </div>
                                                    <div class="col-12 col-md-4">
                                                        <label class="form-label fw-semibold">Auth Token</label>
                                                        <input type="password" id="integrations.twilio.token" class="form-control" placeholder="••••••••">
                                                    </div>
                                                    <div class="col-12 col-md-4">
                                                        <label class="form-label fw-semibold">From (Sender)</label>
                                                        <input type="text" id="integrations.twilio.from" class="form-control" placeholder="+1… or Alphanumeric ID">
                                                    </div>
                                                </div>
                                                <div class="form-text mt-1">Used for OTP during wallet subscription sign‑up.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>                                 

                                <!-- /accordion -->
                            </div>
                        </div>
                        <!-- Webhooks -->
                        <div class="col-12 col-lg-6">
                            <div class="dt-card p-3 p-md-4 h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h2 class="h6 mb-0">Webhooks</h2><span class="text-muted small">Notify your backend</span>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-semibold">Endpoint URL</label>
                                    <input type="url" id="webhooks.endpoint" class="form-control" placeholder="https://api.example.com/webhooks/passkit">
                                    <div class="form-text">We’ll POST event payloads (member.created, redeemed, campaign.sent).</div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label fw-semibold">Secret (HMAC)</label>
                                    <input type="password" id="webhooks.secret" class="form-control" placeholder="whsec_…">
                                    <div class="form-text">We sign requests with <span class="kbd">X‑Signature</span>.
                                    </div>
                                </div>
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox" id="webhooks.enabled">
                                    <label class="form-check-label" for="webhooks.enabled">Enable webhooks</label>
                                </div>
                            </div>
                        </div>
                        <!-- Security -->
                        <div class="col-12 col-lg-6">
                            <div class="dt-card p-3 p-md-4 h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h2 class="h6 mb-0">Security</h2><span class="text-muted small">Session & MFA</span>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="security.enforce2fa">
                                    <label class="form-check-label" for="security.enforce2fa">Require 2FA for all users</label>
                                </div>
                                <div class="row g-2">
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Session Timeout (mins)</label>
                                        <input type="number" min="5" step="5" id="security.sessionTimeout" class="form-control" placeholder="30">
                                    </div>
                                    <div class="col-12 col-sm-6">
                                        <label class="form-label fw-semibold">Allowed IPs (CIDR, optional)</label>
                                        <input type="text" id="security.allowedIps" class="form-control" placeholder="192.168.1.0/24, 203.0.113.4/32">
                                    </div>
                                </div>
                                <div class="form-text mt-1">Leave Allowed IPs blank to allow from anywhere.</div>
                            </div>
                        </div>
                        <!-- Footer actions -->
                        <div class="col-12">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="text-muted small">Changes apply only to this company/tenant.</div>
                                <div class="d-flex gap-2">
                                    <button type="button" id="btnReset" class="btn btn-outline-secondary">Reset</button>
                                    <button type="submit" id="btnSave" class="btn btn-primary">Save changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /row -->
                </form>
                <!-- Toast -->
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
                    <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">Settings saved.</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
    (function(){
      // ---- Session guard (optional) ----
      try {
        if (window.RBAC && typeof RBAC.isAuthenticated === 'function' && !RBAC.isAuthenticated()) {
          sessionStorage.setItem('redirectAfterLogin', 'settings.html');
          location.replace('login.html'); return;
        }
      } catch(_) {}

      // ---- Tiny util to get/set nested values by path like "branding.logoUrl" ----
      function get(obj, path, def){
        return path.split('.').reduce((o,k)=> (o||{})[k], obj) ?? def;
      }
      function set(obj, path, val){
        const keys = path.split('.');
        let cur = obj;
        for (let i=0;i<keys.length-1;i++){
          if (!cur[keys[i]]) cur[keys[i]] = {};
          cur = cur[keys[i]];
        }
        cur[keys[keys.length-1]] = val;
      }

      const DEFAULTS = {
        branding: {
          logoUrl: 'images/DataTech.png',
          displayName: 'DataTech',
          primaryColor: '#1f6feb',
          accentColor: '#10b981'
        },
        company: {
          tenantId: 'demo',
          timezone: 'Asia/Kuwait',
          currency: 'KWD',
          locale: 'en'
        },
        integrations: {
          passkit: { apiKey: '', templateId: '' },
          foodics: { branchId: '', apiToken: '' },
          twilio:  { sid:'', token:'', from:'' }
        },
        webhooks: { endpoint:'', secret:'', enabled:false },
        security: { enforce2fa:false, sessionTimeout:30, allowedIps:'' }
      };

      // ---- Load from localStorage (or use defaults) ----
      function loadSettings(){
        try {
          const raw = localStorage.getItem('DT_SETTINGS');
          if (!raw) return JSON.parse(JSON.stringify(DEFAULTS));
          const parsed = JSON.parse(raw);
          return { ...DEFAULTS, ...parsed }; // shallow merge is fine for demo
        } catch(e){
          console.warn('Failed to parse settings, using defaults', e);
          return JSON.parse(JSON.stringify(DEFAULTS));
        }
      }
      let settings = loadSettings();

      // ---- Bind all inputs by id (id equals path) ----
      const form = document.getElementById('settingsForm');
      const inputs = Array.from(form.querySelectorAll('input, select, textarea'));

      // Set initial values
      for (const el of inputs) {
        const path = el.id;
        if (!path) continue;
        const val = get(settings, path, '');
        if (el.type === 'checkbox'){
          el.checked = !!val;
        } else {
          el.value = (val ?? '').toString();
        }
      }

      // Logo preview + color chips
      const logoUrlEl = document.getElementById('branding.logoUrl');
      const logoImg = document.getElementById('logoImg');
      function refreshLogo(){
        const url = logoUrlEl.value.trim() || 'images/DataTech.png';
        logoImg.src = url;
      }
      logoUrlEl.addEventListener('input', refreshLogo);
      refreshLogo();

      // Save
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        // Collect values
        const out = {};
        for (const el of inputs) {
          const path = el.id;
          if (!path) continue;
          const val = (el.type === 'checkbox') ? el.checked : el.value;
          set(out, path, val);
        }
        // Basic validation examples
        const endpoint = get(out, 'webhooks.endpoint', '').trim();
        if (endpoint && !/^https?:\/\//i.test(endpoint)){
          alert('Webhook endpoint must be a valid http(s) URL.');
          return;
        }
        const currency = get(out, 'company.currency');
        if (!currency){ alert('Currency is required'); return; }

        // Persist (swap this with your API call later)
        try {
          localStorage.setItem('DT_SETTINGS', JSON.stringify(out));
          settings = out;
          // Toast
          const toast = new bootstrap.Toast(document.getElementById('toast'));
          toast.show();
        } catch (ex) {
          alert('Failed to save settings: ' + (ex.message || ex));
        }
      });

      // Reset -> restore defaults (or reload from store)
      document.getElementById('btnReset').addEventListener('click', ()=>{
        settings = loadSettings(); // re-read storage
        for (const el of inputs) {
          const path = el.id;
          if (!path) continue;
          const val = get(settings, path, get(DEFAULTS, path, ''));
          if (el.type === 'checkbox'){
            el.checked = !!val;
          } else {
            el.value = (val ?? '').toString();
          }
        }
        refreshLogo();
      });

      // Schedule input enable/disable in Messages is handled there; not needed here.

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        try{ sessionStorage.removeItem('RBAC_SESSION'); }catch(_){}
        location.href = 'login.html';
      });
    })();
  </script>
    </body>
</html>