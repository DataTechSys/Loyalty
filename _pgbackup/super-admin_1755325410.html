<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Super Admin · Loyalty Console</title>
        <!-- Inter + Bootstrap -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
    :root{
      --dt-bg:#f3f5f9; --dt-card:#ffffff; --dt-text:#0f172a; --dt-muted:#6b7280;
      --dt-primary:#1f6feb; --dt-border:#e5e7eb; --dt-radius-lg:16px; --dt-shadow:0 8px 24px rgba(15,23,42,.06);
      --maxw:1180px; --hover:#fafbff;
    }
    html,body{height:100%}
    body{ background:var(--dt-bg); color:var(--dt-text); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    /* Topbar */
    .dt-topbar{ background:var(--dt-card); border-bottom:1px solid var(--dt-border); position:sticky; top:0; z-index:1030; }
    .dt-brand{ display:flex; align-items:center; gap:.65rem; font-weight:600; }
    .dt-brand img{ width:22px; height:22px; border-radius:6px; }

    /* Page */
    .dt-page{ padding:18px 0 28px; }
    .container-narrow{ max-width: var(--maxw); }

    /* Cards */
    .dt-card{ background:var(--dt-card); border:1px solid var(--dt-border); border-radius:var(--dt-radius-lg); box-shadow:var(--dt-shadow); }
    .p-card{ padding:16px; }
    @media (min-width:768px){ .p-card{ padding:18px; } }

    .btn{ border-radius:12px; }
    .btn-primary{
      --bs-btn-bg: var(--dt-primary); --bs-btn-border-color: var(--dt-primary);
      --bs-btn-hover-bg:#1b5ed1; --bs-btn-hover-border-color:#1b5ed1;
      --bs-btn-active-bg:#184fb3; --bs-btn-active-border-color:#184fb3;
      --bs-btn-shadow:0 8px 18px rgba(31,111,235,.25);
    }
    .form-control, .form-select{ border-radius:12px; }

    .logo-preview{
      width:56px; height:56px; border:1px dashed var(--dt-border); border-radius:12px; display:grid; place-items:center; overflow:hidden; background:#fff;
      color:#64748b; font-size:12px;
    }
    .logo-preview img{ width:100%; height:100%; object-fit:cover; }

    .table thead th{
      color:var(--dt-muted); font-weight:600; font-size:.78rem; text-transform:uppercase; letter-spacing:.04em;
      border-top:0;
    }
    .table > :not(caption) > * > * { border-color: var(--dt-border); }
    .table tbody tr:hover{ background:var(--hover); }

    .badge-soft{ border:1px solid; padding:.3rem .55rem; border-radius:999px; font-weight:700; font-size:.7rem; }
    .st-active{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .st-disabled{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }

    .muted{ color:var(--dt-muted); }
  </style>
    </head>
    <body>
        <!-- Top Bar -->
        <nav class="dt-topbar py-2">
            <div class="container container-narrow d-flex align-items-center justify-content-between">
                <div class="dt-brand">
                    <img src="images/DataTech.png" alt="DataTech"><span>Loyalty Console</span>
                </div>
                <div class="d-flex align-items-center gap-2"><a href="dashboard.html" class="btn btn-outline-secondary btn-sm">Dashboard</a><a href="orders.html" class="btn btn-outline-secondary btn-sm">Orders</a><a href="members.html" class="btn btn-outline-secondary btn-sm">Customers</a><a href="messages.html" class="btn btn-outline-secondary btn-sm">Messages</a><a href="reports.html" class="btn btn-outline-secondary btn-sm">Reports</a><a href="settings.html" class="btn btn-outline-secondary btn-sm">Settings</a>
                    <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
                </div>
            </div>
        </nav>
        <!-- Page -->
        <main class="dt-page">
            <div class="container container-narrow">
                <!-- Title -->
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div>
                        <h1 class="h5 fw-bold mb-0">Super Admin</h1>
                        <div class="text-muted small">Create companies and invite tenant admins</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="btnExport" class="btn btn-outline-secondary btn-sm">Export JSON</button>
                        <label class="btn btn-outline-secondary btn-sm mb-0">
                            Import JSON 

                            <input id="importFile" type="file" accept="application/json" hidden>
                        </label>
                    </div>
                </div>
                <div class="row g-2">
                    <!-- Create Company -->
                    <div class="col-12 col-lg-5">
                        <div class="dt-card p-card">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <h2 class="h6 mb-0">Create Company</h2><span class="text-muted small">Tenant</span>
                            </div>
                            <form id="createForm" class="needs-validation" novalidate>
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="form-label small">Company Name</label>
                                        <input id="cName" type="text" class="form-control" required placeholder="e.g., Koobs Cafe">
                                        <div class="invalid-feedback">Company name is required.</div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Account #</label>
                                        <input id="cAccount" type="text" class="form-control" placeholder="e.g., 900123">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Subdomain</label>
                                        <div class="input-group">
                                            <input id="cSub" type="text" class="form-control" placeholder="koobs" pattern="[a-z0-9\-]{2,}"><span class="input-group-text">.datatech.app</span>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small">Email Domain</label>
                                        <input id="cEmailDom" type="text" class="form-control" placeholder="e.g., koobs.cafe">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Contact Name</label>
                                        <input id="cContact" type="text" class="form-control" placeholder="Owner/Manager">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Contact Phone</label>
                                        <input id="cPhone" type="text" class="form-control" placeholder="+965…">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small d-block">Logo</label>
                                        <div class="d-flex align-items-center gap-2">
                                            <div id="logoPrev" class="logo-preview">Logo</div>
                                            <input id="cLogo" type="file" accept="image/*" class="form-control form-control-sm"/>
                                            <button id="btnClearLogo" type="button" class="btn btn-outline-secondary btn-sm">Clear</button>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small">Notes</label>
                                        <textarea id="cNotes" class="form-control" rows="2" placeholder="Optional notes…"></textarea>
                                    </div>
                                    <div class="col-12 d-grid">
                                        <button class="btn btn-primary" type="submit">Create Company</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Companies List -->
                    <div class="col-12 col-lg-7">
                        <div class="dt-card p-card">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <h2 class="h6 mb-0">Companies</h2>
                                <div class="d-flex gap-2">
                                    <input id="search" class="form-control form-control-sm" placeholder="Search companies…">
                                    <button id="btnSeed" class="btn btn-outline-secondary btn-sm">Seed Demo</button>
                                    <button id="btnClearAll" class="btn btn-outline-danger btn-sm">Clear All</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Company</th>
                                            <th>Account</th>
                                            <th>Subdomain</th>
                                            <th>Status</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">No companies yet</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- Invite Admin Modal -->
        <div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <form id="inviteForm" class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Invite Admin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="invCompanyId">
                        <div class="mb-2">
                            <label class="form-label small">Company</label>
                            <input id="invCompanyName" class="form-control" disabled>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Email</label>
                            <input id="invEmail" type="email" class="form-control" required placeholder="admin@company.com">
                            <div class="invalid-feedback">Valid email required.</div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Role</label>
                            <select id="invRole" class="form-select">
                                <option value="owner">Owner</option>
                                <option value="admin" selected>Admin</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="text-muted small">
                            An email invite link will be generated (mock) and can be used to create the first tenant user.
</div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="submit">Send Invite</button>
                        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Edit Company Modal -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <form id="editForm" class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Company</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editId">
                        <div class="row g-2">
                            <div class="col-12">
                                <label class="form-label small">Company Name</label>
                                <input id="editName" class="form-control" required>
                                <div class="invalid-feedback">Name is required.</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Account #</label>
                                <input id="editAccount" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Subdomain</label>
                                <div class="input-group">
                                    <input id="editSub" class="form-control" pattern="[a-z0-9\-]{2,}"><span class="input-group-text">.datatech.app</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Email Domain</label>
                                <input id="editEmailDom" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Contact</label>
                                <input id="editContact" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Phone</label>
                                <input id="editPhone" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="form-label small d-block">Logo</label>
                                <div class="d-flex align-items-center gap-2">
                                    <div id="editLogoPrev" class="logo-preview">Logo</div>
                                    <input id="editLogo" type="file" accept="image/*" class="form-control form-control-sm"/>
                                    <button id="btnClearEditLogo" type="button" class="btn btn-outline-secondary btn-sm">Clear</button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label small">Notes</label>
                                <textarea id="editNotes" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="submit">Save</button>
                        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
    (function(){
      // --- Optional session guard
      try{
        if (window.RBAC && typeof RBAC.isAuthenticated==='function' && !RBAC.isAuthenticated()){
          sessionStorage.setItem('redirectAfterLogin','super-admin.html');
          location.replace('login.html'); return;
        }
      }catch(_){}

      // Shorthands
      const $ = (id) => document.getElementById(id);
      const asDataUrl = (file) => new Promise((res,rej) => {
        const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file);
      });

      // Mock storage
      const KEY = 'DT_COMPANIES';
      const loadCompanies = () => {
        try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{ return []; }
      };
      const saveCompanies = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));

      // Elements
      const createForm = $('createForm');
      const tbody = $('tbody');
      const search = $('search');
      const cLogo = $('cLogo');
      const logoPrev = $('logoPrev');
      const btnClearLogo = $('btnClearLogo');

      let companies = loadCompanies();
      let filter = '';

      // Render
      function render(){
        const rows = companies
          .filter(c => {
            if (!filter) return true;
            const q = filter.toLowerCase();
            return (c.name||'').toLowerCase().includes(q) ||
                   (c.account||'').toLowerCase().includes(q) ||
                   (c.subdomain||'').toLowerCase().includes(q);
          })
          .map(c => {
            const status = c.disabled ? '<span class="badge-soft st-disabled">Disabled</span>'
                                      : '<span class="badge-soft st-active">Active</span>';
            const logo = c.logo ? `<img src="${c.logo}" alt="" style="width:26px;height:26px;border-radius:6px;object-fit:cover;border:1px solid #eee;">`
                                : `<div style="width:26px;height:26px;border-radius:6px;background:#eef2ff;display:grid;place-items:center;font-weight:700;color:#1f3a8a;">${(c.name||'?').slice(0,1).toUpperCase()}</div>`;
            return `
              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    ${logo}
                    <div>
                      <div class="fw-semibold">${c.name||'-'}</div>
                      <div class="muted small">${c.emailDomain||''}</div>
                    </div>
                  </div>
                </td>
                <td>${c.account||'-'}</td>
                <td>${c.subdomain ? c.subdomain + '.datatech.app' : '-'}</td>
                <td>${status}</td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="SA.invite('${c.id}')">Invite</button>
                    <button class="btn btn-outline-secondary" onclick="SA.edit('${c.id}')">Edit</button>
                    <button class="btn btn-outline-secondary" onclick="SA.toggle('${c.id}')">${c.disabled?'Enable':'Disable'}</button>
                    <button class="btn btn-outline-danger" onclick="SA.remove('${c.id}')">Delete</button>
                  </div>
                </td>
              </tr>
            `;
          });

        tbody.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="5" class="text-center text-muted py-4">No companies found</td></tr>`;
      }

      // Create company
      cLogo.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if (!file){ logoPrev.innerHTML = 'Logo'; return; }
        const url = await asDataUrl(file);
        logoPrev.innerHTML = `<img src="${url}" alt="logo">`;
        logoPrev.dataset.url = url;
      });
      btnClearLogo.addEventListener('click', ()=>{
        cLogo.value = ''; logoPrev.innerHTML = 'Logo'; delete logoPrev.dataset.url;
      });

      createForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        createForm.classList.add('was-validated');
        if (!createForm.checkValidity()) return;

        const id = 'cmp_' + Math.random().toString(36).slice(2,10);
        const now = new Date().toISOString();
        const c = {
          id,
          name: $('cName').value.trim(),
          account: $('cAccount').value.trim(),
          subdomain: $('cSub').value.trim(),
          emailDomain: $('cEmailDom').value.trim(),
          contact: $('cContact').value.trim(),
          phone: $('cPhone').value.trim(),
          logo: logoPrev.dataset.url || '',
          notes: $('cNotes').value.trim(),
          disabled: false,
          createdAt: now,
          admins: []
        };
        companies.unshift(c);
        saveCompanies(companies);
        createForm.reset(); createForm.classList.remove('was-validated');
        logoPrev.innerHTML = 'Logo'; delete logoPrev.dataset.url;
        render();
      });

      // Search
      search.addEventListener('input', ()=>{
        filter = search.value; render();
      });

      // Actions exposed to window for inline buttons
      const inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
      const editModal = new bootstrap.Modal(document.getElementById('editModal'));

      window.SA = {
        invite(id){
          const c = companies.find(x=>x.id===id); if (!c) return;
          $('invCompanyId').value = c.id;
          $('invCompanyName').value = c.name;
          $('invEmail').value = '';
          $('invRole').value = 'admin';
          document.getElementById('inviteForm').classList.remove('was-validated');
          inviteModal.show();
        },
        edit(id){
          const c = companies.find(x=>x.id===id); if (!c) return;
          $('editId').value = c.id;
          $('editName').value = c.name||'';
          $('editAccount').value = c.account||'';
          $('editSub').value = c.subdomain||'';
          $('editEmailDom').value = c.emailDomain||'';
          $('editContact').value = c.contact||'';
          $('editPhone').value = c.phone||'';
          $('editNotes').value = c.notes||'';
          const prev = $('editLogoPrev');
          if (c.logo){ prev.innerHTML = `<img src="${c.logo}" alt="logo">`; prev.dataset.url = c.logo; }
          else { prev.innerHTML = 'Logo'; delete prev.dataset.url; }
          $('editForm').classList.remove('was-validated');
          editModal.show();
        },
        toggle(id){
          const i = companies.findIndex(x=>x.id===id); if (i<0) return;
          companies[i].disabled = !companies[i].disabled;
          saveCompanies(companies); render();
        },
        remove(id){
          if (!confirm('Delete this company? This cannot be undone.')) return;
          companies = companies.filter(c=>c.id!==id);
          saveCompanies(companies); render();
        }
      };

      // Invite form
      $('inviteForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const form = e.currentTarget;
        form.classList.add('was-validated');
        if (!form.checkValidity()) return;

        const id = $('invCompanyId').value;
        const email = $('invEmail').value.trim();
        const role = $('invRole').value;
        const i = companies.findIndex(x=>x.id===id); if (i<0) return;
        const token = Math.random().toString(36).slice(2,10);
        const inviteLink = `${location.origin}${location.pathname.replace('super-admin.html','admin-invite.html')}?token=${token}&company=${encodeURIComponent(companies[i].name)}&email=${encodeURIComponent(email)}&role=${role}`;
        companies[i].admins = companies[i].admins || [];
        companies[i].admins.push({ email, role, invitedAt:new Date().toISOString(), token });
        saveCompanies(companies);
        
        inviteModal.hide();
        alert('Invite (demo) created:\n' + inviteLink + '\n\nCopy this link into an email to the admin.\nIn production, call your email service here.');
      });

      // Edit form
      const editLogo = $('editLogo');
      const editLogoPrev = $('editLogoPrev');
      $('btnClearEditLogo').addEventListener('click', ()=>{
        editLogo.value=''; editLogoPrev.innerHTML='Logo'; delete editLogoPrev.dataset.url;
      });
      editLogo.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if (!file){ editLogoPrev.innerHTML='Logo'; delete editLogoPrev.dataset.url; return; }
        const url = await asDataUrl(file);
        editLogoPrev.innerHTML = `<img src="${url}" alt="logo">`;
        editLogoPrev.dataset.url = url;
      });

      $('editForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const form = e.currentTarget;
        form.classList.add('was-validated');
        if (!form.checkValidity()) return;

        const id = $('editId').value;
        const i = companies.findIndex(x=>x.id===id); if (i<0) return;
        const c = companies[i];
        c.name = $('editName').value.trim();
        c.account = $('editAccount').value.trim();
        c.subdomain = $('editSub').value.trim();
        c.emailDomain = $('editEmailDom').value.trim();
        c.contact = $('editContact').value.trim();
        c.phone = $('editPhone').value.trim();
        c.notes = $('editNotes').value.trim();
        c.logo = editLogoPrev.dataset.url || '';
        saveCompanies(companies);
        editModal.hide(); render();
      });

      // Seed/Clear
      $('btnSeed').addEventListener('click', ()=>{
        if (!confirm('Seed example companies?')) return;
        companies = [
          { id:'cmp_koobs', name:'Koobs Cafe', account:'900123', subdomain:'koobs', emailDomain:'koobs.cafe', contact:'Mustafa', phone:'+965 9xx xxxx', logo:'', notes:'Pilot tenant', disabled:false, createdAt:new Date().toISOString(), admins:[] },
          { id:'cmp_blossom', name:'Blossom Bakery', account:'900221', subdomain:'blossom', emailDomain:'blossom.kw', contact:'Reem', phone:'+965 6xx xxxx', logo:'', notes:'', disabled:false, createdAt:new Date().toISOString(), admins:[] },
          { id:'cmp_kebab', name:'Kebab House', account:'900310', subdomain:'kebabhouse', emailDomain:'kebab.house', contact:'Ali', phone:'+965 5xx xxxx', logo:'', notes:'', disabled:true, createdAt:new Date().toISOString(), admins:[] }
        ];
        saveCompanies(companies); render();
      });

      $('btnClearAll').addEventListener('click', ()=>{
        if (!confirm('Clear ALL companies from this browser?')) return;
        companies = []; saveCompanies(companies); render();
      });

      // Export/Import
      $('btnExport').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(companies, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='companies_backup.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
      $('importFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        try{
          const text = await file.text();
          const arr = JSON.parse(text);
          if (!Array.isArray(arr)) throw new Error('Invalid JSON');
          companies = arr; saveCompanies(companies); render();
        }catch(err){
          alert('Import failed: ' + err.message);
        } finally {
          e.target.value = '';
        }
      });

      // Logout
      $('logoutBtn').addEventListener('click', ()=>{
        try{ sessionStorage.removeItem('RBAC_SESSION'); }catch(_){}
        location.href = 'login.html';
      });

      // Init
      render();
    })();
  </script>
    </body>
</html>