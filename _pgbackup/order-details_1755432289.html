<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Order Details · Loyalty Console</title>
        <!-- Fonts + Bootstrap + Icons -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
        <link rel="icon" type="image/x-icon" href="images/datatech-ico.ico">
        <!-- Your base styles -->
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/sidebar.css">
        <style>
    /* Thin separators inside key/value cards (matches your request) */
    .kv .row + .row { border-top: 1px solid var(--dt-border); }
    .kv .label { color: var(--dt-muted); font-weight: 600; }
    .kv .value { font-weight: 600; }

    /* Soft badges for status & payment types */
    .badge-pill { border-radius: 999px; padding: .35rem .6rem; font-weight: 700; }

    /* Simple gallery for Drive‑Thru / camera images */
    .gallery { display: grid; gap: 8px; grid-template-columns: repeat(3, 1fr); }
    .gallery img { width: 100%; height: 110px; object-fit: cover; border-radius: 10px; border: 1px solid var(--dt-border); }
    @media (max-width: 768px){ .gallery { grid-template-columns: repeat(2, 1fr);} }

    /* Chips row */
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { border: 1px solid var(--dt-border); border-radius: 999px; padding: .2rem .55rem; background:#fff; color:#1f2937; font-weight:600; }

    /* Insights blocks */
    .insight { border:1px solid var(--dt-border); border-radius:14px; padding:12px; background:#fff; }
    .insight .title { font-weight:700; }
  </style>
    </head>
    <body>
        <div class="layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar" data-include="partials/sidebar.html"></aside>
            <!-- Main -->
            <div class="main">
                <!-- Topbar -->
                <div data-include="partials/topbar.html"></div>
                <!-- Page -->
                <main class="page">
                    <div class="container-narrow">
                        <!-- Header row -->
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center gap-3"><a href="orders.html" class="text-muted small"><i class="fa-solid fa-arrow-left me-1"></i>Back</a>
                                <h1 class="h5 fw-bold mb-0">Order <span id="ordRef">—</span></h1><span id="ordStatus" class="badge-pill st-paid">—</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" id="btnPrint">
                                    <i class="fa-solid fa-print me-1"></i>Print
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" id="btnExport">
                                    <i class="fa-solid fa-file-export me-1"></i>Export
                                </button>
                            </div>
                        </div>
                        <!-- Meta & people -->
                        <div class="row g-2">
                            <div class="col-12 col-lg-7">
                                <div class="dt-card p-card kv">
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Business Date</div>
                                        <div class="col value" id="ordBizDate">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Number</div>
                                        <div class="col value" id="ordNumber">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Branch</div>
                                        <div class="col value" id="ordBranch">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Opened At</div>
                                        <div class="col value" id="ordOpened">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Closed At</div>
                                        <div class="col value" id="ordClosed">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Order Type</div>
                                        <div class="col value" id="ordType">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Source</div>
                                        <div class="col value" id="ordSource">—</div>
                                    </div>
                                    <div class="row py-2">
                                        <div class="col-6 col-md-4 label">Guests</div>
                                        <div class="col value" id="ordGuests">—</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-5">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="h6 mb-0">Customer</div><a class="small" id="lnkCustomer" href="#" target="">View profile</a>
                                    </div>
                                    <div class="kv">
                                        <div class="row py-2">
                                            <div class="col-5 label">Name</div>
                                            <div class="col value" id="custName">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-5 label">Phone</div>
                                            <div class="col value" id="custPhone">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-5 label">Membership</div>
                                            <div class="col value" id="custTier">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-5 label">Wallet Balance</div>
                                            <div class="col value" id="custWallet">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-5 label">Tags</div>
                                            <div class="col">
                                                <div class="chips" id="custTags"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Conditional: Order Type specific info -->
                        <div class="row g-2 mt-2" id="typeBlocks">
                            <!-- Drive-thru -->
                            <div class="col-12" id="driveBlock" style="display:none;">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <div class="h6 mb-0">
                                            <i class="fa-solid fa-car-side me-1"></i>Drive‑Thru
                                        </div><span class="text-muted small">Lane <span id="driveLane">—</span></span>
                                    </div>
                                    <div class="kv mb-2">
                                        <div class="row py-2">
                                            <div class="col-4 label">Car Plate</div>
                                            <div class="col value" id="carPlate">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-4 label">Car Make / Color</div>
                                            <div class="col value" id="carMake">—</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="mb-1 fw-semibold">Camera snapshots</div>
                                        <div class="gallery" id="driveImgs"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Delivery -->
                            <div class="col-12" id="delivBlock" style="display:none;">
                                <div class="dt-card p-card">
                                    <div class="h6 mb-1">
                                        <i class="fa-solid fa-motorcycle me-1"></i>Delivery
                                    </div>
                                    <div class="kv">
                                        <div class="row py-2">
                                            <div class="col-4 label">Address</div>
                                            <div class="col value" id="delivAddr">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-4 label">Delivery Note</div>
                                            <div class="col value" id="delivNote">—</div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="mb-1 fw-semibold">Location</div>
                                        <div class="dt-card p-3 text-center" style="border:1px dashed var(--dt-border); border-radius:12px;"><i class="fa-solid fa-map-location-dot me-2"></i>
                                            Map placeholder (embed provider later)
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Dine-in -->
                            <div class="col-12 col-lg-6" id="dineBlock" style="display:none;">
                                <div class="dt-card p-card">
                                    <div class="h6 mb-1">
                                        <i class="fa-solid fa-utensils me-1"></i>Dine‑In
                                    </div>
                                    <div class="kv">
                                        <div class="row py-2">
                                            <div class="col-4 label">Table</div>
                                            <div class="col value" id="tableNo">—</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-4 label">Server</div>
                                            <div class="col value" id="serverName">—</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Walk-in -->
                            <div class="col-12 col-lg-6" id="walkBlock" style="display:none;">
                                <div class="dt-card p-card">
                                    <div class="h6 mb-1">
                                        <i class="fa-solid fa-person-walking me-1"></i>Walk‑In
                                    </div>
                                    <div class="text-muted">Counter order, no seating info captured.</div>
                                </div>
                            </div>
                        </div>
                        <!-- Monetary summary -->
                        <div class="row g-2 mt-2">
                            <div class="col-12 col-lg-7">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h2 class="h6 mb-0">Products</h2><span class="small text-muted" id="itemCount">— items</span>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead>
                                                <tr>
                                                    <th style="width:60px;">Qty</th>
                                                    <th>Item</th>
                                                    <th>Unit</th>
                                                    <th class="text-end">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemsBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-5">
                                <div class="dt-card p-card">
                                    <div class="h6 mb-1">Payment Summary</div>
                                    <div class="kv">
                                        <div class="row py-2">
                                            <div class="col-6 label">Subtotal</div>
                                            <div class="col text-end value" id="sumSubtotal">KWD 0.000</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-6 label">Discounts</div>
                                            <div class="col text-end value text-danger" id="sumDiscount">- KWD 0.000</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-6 label">Taxes</div>
                                            <div class="col text-end value" id="sumTaxes">KWD 0.000</div>
                                        </div>
                                        <div class="row py-2">
                                            <div class="col-6 label">Final Price</div>
                                            <div class="col text-end value" id="sumFinal">KWD 0.000</div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="h6 mb-1">Payments</div>
                                        <div class="table-responsive">
                                            <table class="table align-middle mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th class="text-end">Amount</th>
                                                        <th class="text-end">Added</th>
                                                        <th class="text-end">Ref</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="payBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="h6 mb-1">Payment Type Breakdown</div>
                                        <div class="chips" id="payTypes"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Insights & tags -->
                        <div class="row g-2 mt-2">
                            <div class="col-12 col-lg-7">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <div class="h6 mb-0">Smart insights</div>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-12 col-md-6">
                                            <div class="insight">
                                                <div class="title">Ticket time</div>
                                                <div id="insTicket">—</div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="insight">
                                                <div class="title">Basket size</div>
                                                <div id="insBasket">—</div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="insight">
                                                <div class="title">Notes</div>
                                                <div id="insNotes">—</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-5">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <div class="h6 mb-0">Tags</div>
                                        <button class="btn btn-outline-secondary btn-sm">
                                            <i class="fa-solid fa-tags me-1"></i>Edit Tags
                                        </button>
                                    </div>
                                    <div class="chips" id="ordTags"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Shared helpers -->
        <script src="js/dt-include.js"></script>
        <script src="js/sidebar.js" defer></script>
        <script src="js/app-user.js" defer></script>
        <!-- Page logic (demo data; replace with API later) -->
        <script>
    (function(){
      // --- utilities ---
      const qs = new URLSearchParams(location.search);
      const ID = qs.get('id') || '1770355';
      const TYPE_OVERRIDE = qs.get('type'); // 'drive' | 'delivery' | 'dine' | 'walk'

      const fmtKWD = v => 'KWD ' + Number(v||0).toFixed(3);
      const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };

      // --- demo order (you can swap with real fetch) ---
      const ORDERS = {
        "1770355": {
          id:"1770355",
          number:19,
          branch:"AHB | Abu Halifa",
          businessDate:"2025-08-16",
          openedAt:"August 16, 08:04am",
          closedAt:"August 16, 08:05am",
          source:"Cashier",
          guests:1,
          status:"Done",
          type:"drive", // drive | delivery | dine | walk
          drive:{ lane:"A", carPlate:"12-52143", carMake:"Toyota Corolla · Blue", images:[
            "https://images.unsplash.com/photo-1511919884226-fd3cad34687c?q=80&w=900&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=900&auto=format&fit=crop",
            "https://images.unsplash.com/photo-1517849845537-4d257902454a?q=80&w=900&auto=format&fit=crop"
          ]},
          delivery:{
            address:"Block 3, Street 7, House 15, Salmiya, Kuwait",
            note:"Call on arrival; gate code 4455",
            lat: 29.337, lng: 48.076
          },
          dine:{ table:"T12", server:"Omar" },
          walk:{},
          customer:{
            id:"738868",
            name:"Noura Alazzaz - 738868",
            phone:"+965 9793 5543",
            tier:"Green",
            wallet:3.200,
            tags:["VIP Prospect","Instagram","Arabic"]
          },
          items:[
            {qty:1, name:"ICED | Americano (M)", unit:1.200, total:1.400, notes:"White Mocha Sauce (KWD 0.2)"},
            {qty:1, name:"ICED | Americano (M)", unit:1.200, total:1.400, notes:"White Mocha Sauce (KWD 0.2)"}
            {qty:1, name:"ICED | Americano (M)", unit:1.200, total:1.400, notes:"White Mocha Sauce (KWD 0.2)"}
          ],
          summary:{ subtotal:1.400, discount:0.000, taxes:0.000, final:1.400 },
          payments:[
            {name:"Knet", amount:1.400, added:"August 16, 08:05am", ref:"—"}
          ],
          paySplit:{ Knet:1.400, ApplePay:0, Cash:0, Loyalty:0 },
          tags:["Drive‑thru","Morning Rush"],
          insights:{
            ticketTime:"1m 12s (fast)",
            basket:"1 item · KWD 1.400 (store avg: KWD 2.100)",
            notes:"Regular guest; prefers iced drinks. Consider upsell: croissant."
          }
        }
      };

      const data = JSON.parse(JSON.stringify(ORDERS[ID] || Object.values(ORDERS)[0]));
      if (TYPE_OVERRIDE) data.type = TYPE_OVERRIDE;

      // --- fill header/meta ---
      setText('ordRef', `#${data.id}`);
      setText('ordBizDate', data.businessDate);
      setText('ordNumber', String(data.number));
      setText('ordBranch', data.branch);
      setText('ordOpened', data.openedAt);
      setText('ordClosed', data.closedAt);
      setText('ordType', (data.type==='drive'?'Drive‑Thru':data.type==='delivery'?'Delivery':data.type==='dine'?'Dine‑In':'Walk‑In'));
      setText('ordSource', data.source);
      setText('ordGuests', String(data.guests||'-'));

      // status
      const st = document.getElementById('ordStatus');
      if (st){
        st.textContent = data.status || '—';
        st.className = 'badge-pill ' + (data.status==='Done' ? 'st-paid' : (data.status==='Refunded'?'st-refunded':'st-unpaid'));
      }

      // customer
      setText('custName', data.customer.name);
      setText('custPhone', data.customer.phone || '—');
      setText('custTier', data.customer.tier || '—');
      setText('custWallet', fmtKWD(data.customer.wallet||0));
      const lnk = document.getElementById('lnkCustomer');
      if (lnk) lnk.href = `customer-details.html?id=${encodeURIComponent(data.customer.id)}`;

      const tags = (data.customer.tags||[]).map(t=>`<span class="chip">${t}</span>`).join('');
      document.getElementById('custTags').innerHTML = tags || '<span class="text-muted">—</span>';

      // order type blocks
      document.getElementById('driveBlock').style.display = (data.type==='drive')?'block':'none';
      document.getElementById('delivBlock').style.display = (data.type==='delivery')?'block':'none';
      document.getElementById('dineBlock').style.display  = (data.type==='dine')?'block':'none';
      document.getElementById('walkBlock').style.display  = (data.type==='walk')?'block':'none';

      if (data.type==='drive'){
        setText('driveLane', data.drive.lane || '—');
        setText('carPlate', data.drive.carPlate || '—');
        setText('carMake', data.drive.carMake || '—');
        const imgs = (data.drive.images||[]).slice(0,6).map(src=>`<img src="${src}" alt="">`).join('');
        document.getElementById('driveImgs').innerHTML = imgs || '<div class="text-muted small">No snapshots</div>';
      }
      if (data.type==='delivery'){
        setText('delivAddr', data.delivery.address || '—');
        setText('delivNote', data.delivery.note || '—');
      }
      if (data.type==='dine'){
        setText('tableNo', data.dine.table || '—');
        setText('serverName', data.dine.server || '—');
      }

      // items table
      const itemsBody = document.getElementById('itemsBody');
      itemsBody.innerHTML = (data.items||[]).map(it=>`
        <tr>
          <td>${it.qty}</td>
          <td>
            <div class="fw-semibold">${it.name}</div>
            ${it.notes ? `<div class="text-muted small">${it.notes}</div>`:''}
          </td>
          <td>${fmtKWD(it.unit)}</td>
          <td class="text-end">${fmtKWD(it.total)}</td>
        </tr>
      `).join('');
      setText('itemCount', `${(data.items||[]).length} ${((data.items||[]).length===1?'item':'items')}`);

      // summary
      setText('sumSubtotal', fmtKWD(data.summary.subtotal));
      setText('sumDiscount', (data.summary.discount>0?'- ':'')+fmtKWD(data.summary.discount));
      setText('sumTaxes', fmtKWD(data.summary.taxes));
      setText('sumFinal', fmtKWD(data.summary.final));

      // payments
      document.getElementById('payBody').innerHTML = (data.payments||[]).map(p=>`
        <tr>
          <td>${p.name}</td>
          <td class="text-end">${fmtKWD(p.amount)}</td>
          <td class="text-end">${p.added}</td>
          <td class="text-end">${p.ref||'—'}</td>
        </tr>
      `).join('');

      // pay type chips
      const split = data.paySplit||{};
      document.getElementById('payTypes').innerHTML =
        Object.keys(split).filter(k=>split[k]>0).map(k=>`<span class="chip">${k}: ${fmtKWD(split[k])}</span>`).join('') ||
        '<span class="text-muted">—</span>';

      // insights
      setText('insTicket', data.insights.ticketTime);
      setText('insBasket', data.insights.basket);
      setText('insNotes',  data.insights.notes);

      // order tags
      document.getElementById('ordTags').innerHTML = (data.tags||[]).map(t=>`<span class="chip">${t}</span>`).join('') || '<span class="text-muted">—</span>';

      // actions
      document.getElementById('btnPrint')?.addEventListener('click',()=>window.print());
      document.getElementById('btnExport')?.addEventListener('click',()=>{
        const csv = [
          ['Field','Value'],
          ['Order ID', data.id],
          ['Number', data.number],
          ['Business Date', data.businessDate],
          ['Opened At', data.openedAt],
          ['Closed At', data.closedAt],
          ['Type', data.type],
          ['Branch', data.branch],
          ['Customer', data.customer.name],
          ['Final Price', data.summary.final]
        ].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `order_${data.id}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
    })();
  </script>
    </body>
</html>