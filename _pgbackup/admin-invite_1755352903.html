<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Admin Invite · Loyalty Console</title>
        <!-- Inter + Bootstrap -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
    :root{
      --dt-bg:#f3f5f9; --dt-card:#ffffff; --dt-text:#0f172a; --dt-muted:#6b7280;
      --dt-primary:#1f6feb; --dt-border:#e5e7eb; --dt-radius-lg:16px; --dt-shadow:0 8px 24px rgba(15,23,42,.06);
      --maxw:760px;
    }
    html,body{height:100%}
    body{ background:var(--dt-bg); color:var(--dt-text); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    /* Topbar (shows user chip if someone is already logged in) */
    .dt-topbar{ background:var(--dt-card); border-bottom:1px solid var(--dt-border); position:sticky; top:0; z-index:1030; }
    .dt-brand{ display:flex; align-items:center; gap:.65rem; font-weight:600; }
    .dt-brand img{ width:22px; height:22px; border-radius:6px; }

    .container-narrow{ max-width: var(--maxw); }

    .auth-card{
      background:var(--dt-card); border:1px solid var(--dt-border); border-radius:var(--dt-radius-lg); box-shadow:var(--dt-shadow);
    }
    .p-card{ padding:18px; }
    .btn{ border-radius:12px; }
    .btn-primary{
      --bs-btn-bg: var(--dt-primary); --bs-btn-border-color: var(--dt-primary);
      --bs-btn-hover-bg:#1b5ed1; --bs-btn-hover-border-color:#1b5ed1;
      --bs-btn-active-bg:#184fb3; --bs-btn-active-border-color:#184fb3;
      --bs-btn-shadow:0 8px 18px rgba(31,111,235,.25);
    }
    .form-control, .form-select{ border-radius:12px; }
    .muted{ color:var(--dt-muted); }

    .avatar-preview{
      width:64px; height:64px; border-radius:50%; border:1px dashed var(--dt-border);
      display:grid; place-items:center; overflow:hidden; background:#fff; color:#64748b; font-weight:700;
    }
    .avatar-preview img{ width:100%; height:100%; object-fit:cover; }
    .token-bad{
      border:1px solid #fecaca; background:#fef2f2; color:#991b1b; border-radius:12px; padding:14px;
    }
    .token-good{
      border:1px solid #bbf7d0; background:#f0fdf4; color:#14532d; border-radius:12px; padding:14px;
    }
  </style>
    </head>
    <body>
        <!-- Top Bar -->
        <nav class="dt-topbar py-2">
            <div class="container container-narrow d-flex align-items-center justify-content-between">
                <div class="dt-brand">
                    <img src="images/DataTech.png" alt="DataTech"><span>Loyalty Console</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <!-- user chip auto-injected by app-user.js --><a href="login.html" class="btn btn-outline-secondary btn-sm">Login</a>
                </div>
            </div>
        </nav>
        <main class="py-4">
            <div class="container container-narrow">
                <div class="mb-3">
                    <h1 class="h5 fw-bold mb-0">Accept Admin Invite</h1>
                    <div class="text-muted small">Create your account for this company</div>
                </div>
                <div id="tokenState" class="mb-3"></div>
                <div class="auth-card p-card">
                    <form id="inviteForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label small">Company</label>
                                <input id="companyName" class="form-control" disabled>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small">Role</label>
                                <input id="role" class="form-control" disabled>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small">Email</label>
                                <input id="email" type="email" class="form-control" disabled>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small">Set Password</label>
                                <input id="password" type="password" class="form-control" minlength="6" required placeholder="Min 6 characters">
                                <div class="invalid-feedback">Password must be at least 6 characters.</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small">Your Full Name</label>
                                <input id="fullName" class="form-control" required placeholder="e.g., Reem Al‑X">
                                <div class="invalid-feedback">Name is required.</div>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label small d-block">Avatar</label>
                                <div class="d-flex align-items-center gap-2">
                                    <div id="avatarPrev" class="avatar-preview">A</div>
                                    <input id="avatarFile" type="file" accept="image/*" class="form-control form-control-sm"/>
                                    <button id="clearAvatar" type="button" class="btn btn-outline-secondary btn-sm">Clear</button>
                                </div>
                                <div class="form-text">Optional — you can add later in Settings.</div>
                            </div>
                            <div class="col-12">
                                <button id="acceptBtn" class="btn btn-primary" type="submit">Create Account</button><a href="dashboard.html" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </div>
                        <input type="hidden" id="companyId">
                        <input type="hidden" id="inviteToken">
                    </form>
                </div>
            </div>
        </main>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- User chip (auto renders avatar + name if already logged in) -->
        <script src="app-user.js"></script>
        <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const asDataUrl = (file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });

      // Storage keys used across pages
      const KEY_COMPANIES = 'DT_COMPANIES';
      const KEY_USERS     = 'DT_USERS';
      const KEY_SESSION   = 'RBAC_SESSION';
      const KEY_USER      = 'RBAC_USER';

      const qs = new URLSearchParams(location.search);
      const token   = qs.get('token') || '';
      const email   = qs.get('email') || '';
      const role    = qs.get('role')  || 'admin';
      const company = qs.get('company') || '';

      // Load companies and validate token
      function loadCompanies(){
        try{ return JSON.parse(localStorage.getItem(KEY_COMPANIES)||'[]'); }catch{return [];}
      }
      let companies = loadCompanies();

      let foundCompany = null, foundInvite = null;

      if (token && companies.length){
        // find invite token inside any company
        for (const c of companies){
          const inv = (c.admins||[]).find(a => a.token===token && (!a.acceptedAt));
          if (inv){
            foundCompany = c; foundInvite = inv; break;
          }
        }
      }

      // Populate UI / token state
      const tokenState = $('tokenState');
      if (!token || !foundCompany || !foundInvite){
        tokenState.className = 'token-bad mb-3';
        tokenState.innerHTML = `<strong>Invalid or already used link.</strong><br>
          Ask the Super Admin to send a new invite.`;
        // Disable the form
        $('inviteForm').querySelectorAll('input,button,select,textarea').forEach(el => el.disabled = true);
      } else {
        tokenState.className = 'token-good mb-3';
        tokenState.innerHTML = `<strong>You're invited to join:</strong> ${foundCompany.name} <span class="text-muted">as</span> ${foundInvite.role.toUpperCase()}`;
        $('companyName').value = foundCompany.name;
        $('role').value = foundInvite.role;
        $('email').value = foundInvite.email;
        $('companyId').value = foundCompany.id;
        $('inviteToken').value = token;
      }

      // Avatar preview
      const avatarPrev = $('avatarPrev');
      $('avatarFile').addEventListener('change', async (e)=>{
        const f = e.target.files?.[0]; if (!f){ avatarPrev.textContent='A'; delete avatarPrev.dataset.url; return; }
        const url = await asDataUrl(f);
        avatarPrev.innerHTML = `<img src="${url}" alt="avatar">`;
        avatarPrev.dataset.url = url;
      });
      $('clearAvatar').addEventListener('click', ()=>{
        $('avatarFile').value=''; avatarPrev.textContent='A'; delete avatarPrev.dataset.url;
      });

      // Create account
      $('inviteForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const form = e.currentTarget;
        form.classList.add('was-validated');
        if (!form.checkValidity()) return;

        if (!foundCompany || !foundInvite){
          alert('Invite is not valid anymore.'); return;
        }

        const fullName = $('fullName').value.trim();
        const password = $('password').value;
        const photoUrl = avatarPrev.dataset.url || '';
        const compId   = $('companyId').value;

        // Save user locally
        const users = (()=>{
          try{ return JSON.parse(localStorage.getItem(KEY_USERS)||'[]'); }catch{return [];}
        })();

        const userId = 'usr_' + Math.random().toString(36).slice(2,10);
        const user = {
          id: userId,
          companyId: compId,
          email: foundInvite.email,
          role: foundInvite.role,
          name: fullName,
          photoUrl,
          passwordHash: 'demo:' + btoa(password), // DEMO ONLY
          createdAt: new Date().toISOString()
        };
        users.push(user);
        localStorage.setItem(KEY_USERS, JSON.stringify(users));

        // Mark invite as accepted
        companies = loadCompanies();
        const ci = companies.findIndex(c => c.id===compId);
        if (ci>=0){
          const ai = (companies[ci].admins||[]).findIndex(a => a.token===foundInvite.token);
          if (ai>=0){
            companies[ci].admins[ai].acceptedAt = new Date().toISOString();
          }
          localStorage.setItem(KEY_COMPANIES, JSON.stringify(companies));
        }

        // Log the user in (demo session)
        const session = {
          userId, companyId: compId, email: user.email, role: user.role, issuedAt: Date.now()
        };
        localStorage.setItem(KEY_SESSION, JSON.stringify(session));
        localStorage.setItem(KEY_USER, JSON.stringify({ name: user.name, photoUrl: user.photoUrl, email: user.email }));

        alert('Account created. Redirecting to dashboard…');
        location.replace('dashboard.html');
      });
    })();
  </script>
    </body>
</html>