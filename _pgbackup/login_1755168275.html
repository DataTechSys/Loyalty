<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>Sign in · Loyalty Console</title>
        <!-- Bootstrap & your styles -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <link href="css/style.css" rel="stylesheet"/>
        <!-- Auth + Config + API (login page loads them too, but NO guard here) -->
        <script src="js/app-auth.js"></script>
        <script src="js/config.js"></script>
        <script src="js/api.js"></script>
        <style>body { background: #f6f7fb; } .login-card { max-width: 440px; margin: 8vh auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); } .brand-logo { display: block; margin: -36px auto 12px; width: 64px; height: 64px; object-fit: contain; }</style>
    </head>
    <body>
        <div class="card login-card">
            <div class="card-body p-4 text-center">
                <img src="images/DataTech.png" alt="DataTech Logo" class="brand-logo">
                <h5 class="mb-3">Sign in</h5>
                <div id="alertBox" class="alert alert-danger py-2 d-none" role="alert"></div>
                <form id="loginForm" novalidate>
                    <div class="mb-3 text-start">
                        <label for="tenantId" class="form-label">Company / Account ID</label>
                        <input id="tenantId" name="tenantId" type="text" class="form-control" placeholder="Enter company/account ID" required>
                    </div>
                    <div class="mb-3 text-start">
                        <label for="email" class="form-label">Email</label>
                        <input id="email" name="email" type="email" class="form-control" placeholder="you@example.com" required>
                    </div>
                    <div class="mb-3 text-start">
                        <label for="password" class="form-label">Password</label>
                        <input id="password" name="password" type="password" class="form-control" placeholder="••••••••" required>
                    </div>
                    <button id="submitBtn" type="submit" class="btn btn-primary w-100">Sign in</button>
                </form>
                <p class="text-muted small mt-3 mb-0">© 2025 DataTech</p>
            </div>
        </div>
        <script>
    (function(){
      const form  = document.getElementById('loginForm');
      const btn   = document.getElementById('submitBtn');
      const alertBox = document.getElementById('alertBox');

      function showError(msg){
        alertBox.textContent = msg || 'Sign-in failed. Please try again.';
        alertBox.classList.remove('d-none');
      }
      function hideError(){
        alertBox.classList.add('d-none');
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        hideError();

        const tenantId = form.tenantId.value.trim();
        const email    = form.email.value.trim();
        const password = form.password.value;

        if(!tenantId || !email || !password){
          showError('Please fill in all fields.');
          return;
        }

        try {
          btn.disabled = true;
          btn.innerText = 'Signing in…';

          const session = await API.login(email, password, tenantId);

          RBAC.setActiveTenant(tenantId);
          if (!session.tenantId) session.tenantId = tenantId;
          RBAC.setSession(session);

          const redirect = sessionStorage.getItem('redirectAfterLogin') || 'dashboard.html';
          sessionStorage.removeItem('redirectAfterLogin');
          location.replace(redirect);
        } catch(err){
          console.error(err);
          showError(err?.message || 'Unable to sign in.');
        } finally {
          btn.disabled = false;
          btn.innerText = 'Sign in';
        }
      });

      try {
        if (window.RBAC && RBAC.isAuthenticated()) {
          const to = sessionStorage.getItem('redirectAfterLogin') || 'dashboard.html';
          location.replace(to);
        }
      } catch {}
    })();
  </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/config.js"></script>
        <script src="js/rbac.js"></script>         

        <!-- defines window.RBAC -->
        <script src="js/app-auth.js"></script>         

        <!-- uses window.RBAC -->
        <script src="js/app.js"></script>
    </body>
</html>
