<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Customer · Loyalty Console</title>
        <!-- Fonts + Bootstrap + Icons -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
        <link href="css/style.css" rel="stylesheet">
    </head>
    <body>
        <div class="layout">
            <!-- Reusable Sidebar -->
            <aside class="sidebar" id="sidebar" data-include="partials/sidebar.html"></aside>
            <!-- Main -->
            <div class="main">
                <!-- Topbar (no center title; user chip on the right) -->
                <header class="dt-topbar">
                    <div class="tb-inner container d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn-icon burger" id="burger" aria-label="Toggle menu">☰</button>
                            <button class="btn-icon" id="collapseBtn" aria-label="Collapse sidebar">
                                <i class="fa-solid fa-bars"></i>
                            </button>
                        </div>
                        <div class="flex-grow-1"></div>
                        <div class="d-flex align-items-center gap-2 userchip-wrap">
                            <!-- injected by js/app-user.js -->
                        </div>
                    </div>
                </header>
                <!-- Page -->
                <main class="page">
                    <div class="container-narrow">
                        <!-- Back + Actions -->
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center gap-2"><a href="customers.html" class="btn btn-outline-secondary btn-sm"> <i class="fa-solid fa-chevron-left me-1"></i>Back </a>
                                <h1 class="h5 fw-bold mb-0" id="custTitle">Customer</h1>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" id="btnEnableLoyalty"><i class="fa-solid fa-tag me-1"></i>Enable Loyalty
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" id="btnEnableHouse"><i class="fa-solid fa-id-card me-1"></i>Enable House Account
                                </button><a href="edit-customer.html" class="btn btn-primary btn-sm">
                Edit Customer </a>
                            </div>
                        </div>
                        <!-- KPI Cards -->
                        <div class="row g-2">
                            <div class="col-12 col-md-4">
                                <div class="dt-card p-card">
                                    <div class="text-muted small">Done Orders</div>
                                    <div class="display-6 fw-bold" id="kpiOrders">0</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="dt-card p-card">
                                    <div class="text-muted small">Total Spent (KWD)</div>
                                    <div class="display-6 fw-bold" id="kpiSpent">0</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="dt-card p-card">
                                    <div class="text-muted small">Total Discounts (KWD)</div>
                                    <div class="display-6 fw-bold" id="kpiDiscounts">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-12 col-md-4">
                                <div class="dt-card p-card">
                                    <div class="text-muted small">Last Order</div>
                                    <div class="fw-semibold" id="kpiLastOrder">-</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="dt-card p-card">
                                    <div class="text-muted small">Favourite Product</div>
                                    <div class="fw-semibold" id="kpiFavProduct">-</div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="dt-card p-card">
                                    <div class="text-muted small">Favourite Branch</div>
                                    <div class="fw-semibold" id="kpiFavBranch">-</div>
                                </div>
                            </div>
                        </div>
                        <!-- Profile + Loyalty -->
                        <div class="row g-2 mt-2">
                            <div class="col-12">
                                <div class="dt-card p-card">
                                    <h2 class="h6 mb-2">Profile</h2>
                                    <div class="row g-2">
                                        <div class="col-12 col-md-6">
                                            <div class="border rounded p-2">
                                                <div class="row small">
                                                    <div class="col-4 text-muted">Name</div>
                                                    <div class="col-8 fw-semibold" id="fldName">—</div>
                                                    <div class="col-4 text-muted mt-2">Phone</div>
                                                    <div class="col-8 mt-2" id="fldPhone">—</div>
                                                    <div class="col-4 text-muted mt-2">Loyalty</div>
                                                    <div class="col-8 mt-2" id="fldLoyalty">Disabled</div>
                                                    <div class="col-4 text-muted mt-2">Blacklist</div>
                                                    <div class="col-8 mt-2" id="fldBlacklist">No</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="border rounded p-2">
                                                <div class="row small">
                                                    <div class="col-4 text-muted">Email</div>
                                                    <div class="col-8" id="fldEmail">—</div>
                                                    <div class="col-4 text-muted mt-2">Birth Date</div>
                                                    <div class="col-8 mt-2" id="fldBirth">—</div>
                                                    <div class="col-4 text-muted mt-2">House Accounts</div>
                                                    <div class="col-8 mt-2" id="fldHouse">Disabled</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Loyalty from PassKit -->
                                    <div class="border rounded p-2 mt-2">
                                        <div class="row g-2 align-items-center">
                                            <div class="col-12 col-lg">
                                                <div class="d-flex flex-wrap gap-3">
                                                    <div>
                                                        <div class="text-muted small">Membership Tier</div>
                                                        <div class="fw-semibold" id="loyTier">—</div>
                                                    </div>
                                                    <div>
                                                        <div class="text-muted small">Wallet Balance</div>
                                                        <div class="fw-semibold" id="loyWallet">KWD 0.000</div>
                                                    </div>
                                                    <div>
                                                        <div class="text-muted small">Points</div>
                                                        <div class="fw-semibold" id="loyPoints">0 (KWD 0.000)</div>
                                                        <div class="small text-muted">* 1,000 pts = 1.000 KWD (5% cashback)</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12 col-lg-auto">
                                                <button class="btn btn-outline-secondary btn-sm" id="btnAdjustPoints">
                                                    Adjust Points
</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Points History + Coupons -->
                        <div class="row g-2 mt-2">
                            <div class="col-12 col-lg-6">
                                <div class="dt-card p-card h-100">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h2 class="h6 mb-0">Points History</h2>
                                        <button class="btn btn-outline-secondary btn-sm" id="btnExportPts">Export CSV</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Change</th>
                                                    <th>Reason</th>
                                                </tr>
                                            </thead>
                                            <tbody id="pointsBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="dt-card p-card h-100">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h2 class="h6 mb-0">Coupons</h2>
                                        <button class="btn btn-outline-secondary btn-sm" id="btnSendCoupon">Send Coupon</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Code</th>
                                                    <th>Title</th>
                                                    <th>Status</th>
                                                    <th class="text-end">Expires</th>
                                                </tr>
                                            </thead>
                                            <tbody id="couponBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Orders (recent) -->
                        <div class="row g-2 mt-2">
                            <div class="col-12">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h2 class="h6 mb-0">Recent Orders</h2><a href="orders.html" class="small">View all</a>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Order</th>
                                                    <th>When</th>
                                                    <th>Payment</th>
                                                    <th class="text-end">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ordersBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tags -->
                        <div class="row g-2 mt-2">
                            <div class="col-12">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h2 class="h6 mb-0">Tags</h2>
                                        <button class="btn btn-outline-secondary btn-sm">Add Tags</button>
                                    </div>
                                    <div class="text-muted small">You can add tags to this customer for filtering or assigning promotions.</div>
                                </div>
                            </div>
                        </div>
                        <!-- Addresses -->
                        <div class="row g-2 mt-2">
                            <div class="col-12">
                                <div class="dt-card p-card">
                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                        <h2 class="h6 mb-0">Addresses</h2>
                                        <button class="btn btn-outline-secondary btn-sm">Add Address</button>
                                    </div>
                                    <div class="text-muted small">Add this customer's addresses and assign them to delivery zones for delivery orders.</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center text-muted small mt-3">© DataTech 2025</div>
                    </div>
                </main>
            </div>
        </div>
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Global user/session helper (renders top user chip) -->
        <script src="js/app-user.js"></script>
        <script>
  // --- Sidebar include + toggles (same pattern as other pages) -------------
  (function(){
    const host = document.querySelector('[data-include="sidebar.html"]');
    if (host) {
      fetch('sidebar.html').then(r=>r.text()).then(html=>{
        host.innerHTML = html;

        // highlight current section (Customers)
        const link = host.querySelector('a[href="customers.html"]');
        link?.classList.add('active');

        // collapse/expand on mobile + collapse width
        document.getElementById('burger')?.addEventListener('click',()=> host.classList.toggle('open'));
        document.getElementById('collapseBtn')?.addEventListener('click',()=> host.classList.toggle('collapsed'));

        // dropdowns in sidebar
        host.querySelectorAll('[data-bs-toggle="collapse"]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const target = btn.getAttribute('data-bs-target');
            if (!target) return;
            const el = host.querySelector(target);
            if (el) el.classList.toggle('show');
          });
        });
      });
    }
  })();

  // ----------------- Demo data wiring (POS + PassKit) ----------------------
  (function(){
    // Currency and points helpers
    const fmtKWD = v => 'KWD ' + Number(v||0).toLocaleString(undefined,{minimumFractionDigits:3, maximumFractionDigits:3});
    const ptsToKWD = pts => (Number(pts||0) / 1000);

    // Pretend we read query ?id=... ; for demo we hardcode one profile
    const CUSTOMER = {
      id: '738868',
      name: 'Noura Alazzaz',
      phone: '+965 9793 5543',
      email: '',
      birth: '1997-08-21',
      loyaltyEnabled: false,
      blacklisted: false,
      houseEnabled: false
    };

    // POS aggregates (you’d replace with real API)
    const POS = {
      doneOrders: 0,
      totalSpent: 0.000,
      totalDiscounts: 0.000,
      lastOrder: '-',
      favProduct: '-',
      favBranch: '-',
      recentOrders: [
        // {id:1770355, when:'Aug 16, 08:05', pay:'Knet', amount:1.400},
      ]
    };

    // PassKit snapshot (you’d replace with real API)
    const PASSKIT = {
      tier: 'Green',                 // Green / Silver / Gold / Platinum
      points: 0,                     // integer points
      walletKWD: 0.000,              // current wallet balance
      history: [
        // {date:'2025-08-01 09:30', change:+120, reason:'Order #1769500 (5% back)'},
        // {date:'2025-08-05 11:02', change:-200, reason:'Redeemed in-store'},
      ],
      coupons: [
        // {code:'WELCOME5', title:'KD 0.500 Off', status:'Redeemed', expires:'2025-08-31'},
        // {code:'WEEKEND10', title:'10% off',      status:'Sent',     expires:'2025-08-20'},
        // {code:'SUMMERX',  title:'Free Add-on',  status:'Expired',  expires:'2025-07-31'},
      ]
    };

    // ---------- Fill basics ----------
    document.getElementById('custTitle').textContent = `${CUSTOMER.name} · ${CUSTOMER.id}`;
    document.getElementById('fldName').textContent  = `${CUSTOMER.name} · ${CUSTOMER.id}`;
    document.getElementById('fldPhone').textContent = CUSTOMER.phone || '—';
    document.getElementById('fldEmail').textContent = CUSTOMER.email || '—';
    document.getElementById('fldBirth').textContent = CUSTOMER.birth || '—';
    document.getElementById('fldLoyalty').textContent = CUSTOMER.loyaltyEnabled ? 'Enabled' : 'Disabled';
    document.getElementById('fldBlacklist').textContent = CUSTOMER.blacklisted ? 'Yes' : 'No';
    document.getElementById('fldHouse').textContent = CUSTOMER.houseEnabled ? 'Enabled' : 'Disabled';

    // ---------- KPIs ----------
    document.getElementById('kpiOrders').textContent    = POS.doneOrders.toLocaleString();
    document.getElementById('kpiSpent').textContent     = fmtKWD(POS.totalSpent);
    document.getElementById('kpiDiscounts').textContent = fmtKWD(POS.totalDiscounts);
    document.getElementById('kpiLastOrder').textContent = POS.lastOrder;
    document.getElementById('kpiFavProduct').textContent= POS.favProduct;
    document.getElementById('kpiFavBranch').textContent = POS.favBranch;

    // ---------- Loyalty snapshot ----------
    const ptsKwd = ptsToKWD(PASSKIT.points);
    document.getElementById('loyTier').textContent   = PASSKIT.tier;
    document.getElementById('loyWallet').textContent = fmtKWD(PASSKIT.walletKWD);
    document.getElementById('loyPoints').textContent = `${(PASSKIT.points||0).toLocaleString()} ( ${fmtKWD(ptsKwd)} )`;

    // ---------- Points history ----------
    document.getElementById('pointsBody').innerHTML = (PASSKIT.history.length
      ? PASSKIT.history.map(h=>`
        <tr>
          <td>${h.date}</td>
          <td class="${h.change>=0?'text-success':'text-danger'}">
            ${h.change>=0?'+':''}${h.change.toLocaleString()} pts
          </td>
          <td>${h.reason||''}</td>
        </tr>`).join('')
      : `<tr><td colspan="3" class="text-muted">No history.</td></tr>`
    );

    // ---------- Coupons ----------
    const pill = s => {
      const map = { Redeemed:'success', Sent:'secondary', Expired:'warning' };
      const cls = map[s] || 'secondary';
      return `<span class="badge text-bg-${cls}">${s}</span>`;
    };
    document.getElementById('couponBody').innerHTML = (PASSKIT.coupons.length
      ? PASSKIT.coupons.map(c=>`
        <tr>
          <td class="fw-semibold">${c.code}</td>
          <td>${c.title||''}</td>
          <td>${pill(c.status||'Sent')}</td>
          <td class="text-end">${c.expires||'-'}</td>
        </tr>`).join('')
      : `<tr><td colspan="4" class="text-muted">No coupons.</td></tr>`
    );

    // ---------- Orders preview ----------
    document.getElementById('ordersBody').innerHTML = (POS.recentOrders.length
      ? POS.recentOrders.map(r=>`
        <tr>
          <td><a href="order-details.html?id=${r.id}">#${r.id}</a></td>
          <td>${r.when}</td>
          <td>${r.pay||'-'}</td>
          <td class="text-end">${fmtKWD(r.amount)}</td>
        </tr>`).join('')
      : `<tr><td colspan="4" class="text-muted">No orders yet.</td></tr>`
    );

    // ---------- Demo actions ----------
    document.getElementById('btnEnableLoyalty')?.addEventListener('click', ()=>{
      alert('Enable Loyalty (demo)');
    });
    document.getElementById('btnEnableHouse')?.addEventListener('click', ()=>{
      alert('Enable House Account (demo)');
    });
    document.getElementById('btnAdjustPoints')?.addEventListener('click', ()=>{
      alert('Adjust points (demo)');
    });
    document.getElementById('btnExportPts')?.addEventListener('click', ()=>{
      // Simple CSV export of points history (demo)
      const lines = ['Date,Change,Reason'].concat(
        (PASSKIT.history||[]).map(h => [
          `"${h.date}"`,
          `"${h.change}"`,
          `"${(h.reason||'').replace(/"/g,'""')}"`
        ].join(','))
      );
      const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `points-${CUSTOMER.id}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnSendCoupon')?.addEventListener('click', ()=>{
      alert('Send coupon (demo)');
    });
  })();
  </script>
    </body>
</html>