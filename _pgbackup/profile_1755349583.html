<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Profile · Loyalty Console</title>
        <!-- Fonts + Bootstrap + Icons -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
        <link rel="icon" type="image/x-icon" href="images/datatech-ico.ico">
        <!-- Theme CSS -->
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/sidebar.css">
        <!-- Cropper.js -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css"/>
        <style>
    .crop-stage{
      width:100%;max-height:60vh;background:#f8fafc;border:1px dashed var(--dt-border);
      border-radius:12px;display:grid;place-items:center;overflow:hidden
    }
    .crop-stage img{max-width:100%;display:block}
    .avatar-preview{
      width:80px;height:80px;border-radius:50%;object-fit:cover;border:1px solid var(--dt-border);
      background:#fff;box-shadow:var(--dt-shadow)
    }
  </style>
    </head>
    <body>
        <div class="layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar" data-include="partials/sidebar.html"></aside>
            <!-- Main -->
            <div class="main">
                <!-- Topbar -->
                <div data-include="partials/topbar.html"></div>
                <main class="page">
                    <div class="container-narrow">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <h1 class="h5 fw-bold mb-0">Profile</h1>
                                <div class="text-muted small">Update your avatar and account security</div>
                            </div>
                            <img id="avatarPreview" class="avatar-preview" alt="Avatar preview">
                        </div>
                        <div class="row g-2">
                            <!-- Left: Avatar crop/upload -->
                            <div class="col-12 col-lg-7">
                                <div class="dt-card p-card">
                                    <h2 class="h6 mb-2">Avatar</h2>
                                    <div class="text-muted small mb-2">Choose a photo, crop to square, and upload. Max 5 MB.</div>
                                    <div class="mb-2">
                                        <input class="form-control" type="file" id="fileInput" accept="image/*">
                                    </div>
                                    <div class="crop-stage mb-2">
                                        <img id="cropImage" alt="Selected image will appear here">
                                    </div>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-secondary btn-sm" id="zoomOut" title="Zoom out"><i class="fa-solid fa-magnifying-glass-minus"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="zoomIn" title="Zoom in"><i class="fa-solid fa-magnifying-glass-plus"></i>
                                            </button>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-secondary btn-sm" id="rotateL" title="Rotate left"><i class="fa-solid fa-rotate-left"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="rotateR" title="Rotate right"><i class="fa-solid fa-rotate-right"></i>
                                            </button>
                                        </div>
                                        <button class="btn btn-outline-secondary btn-sm" id="reset"><i class="fa-solid fa-arrows-rotate me-1"></i>Reset
                                        </button>
                                        <button class="btn btn-primary btn-sm ms-auto" id="upload"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Right: Account + Password -->
                            <div class="col-12 col-lg-5">
                                <div class="dt-card p-card mb-2">
                                    <h2 class="h6 mb-2">Account details</h2>
                                    <form id="accountForm" class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label small">Full name</label>
                                            <input type="text" id="accName" class="form-control" placeholder="Your name" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small">Email</label>
                                            <input type="email" id="accEmail" class="form-control" placeholder="you@example.com" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small">Role</label>
                                            <input type="text" id="accRole" class="form-control" disabled>
                                        </div>
                                        <div class="col-12 d-grid">
                                            <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk me-1"></i>Save changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="dt-card p-card">
                                    <h2 class="h6 mb-2">Change password</h2>
                                    <form id="pwdForm" class="row g-2">
                                        <div class="col-12">
                                            <label class="form-label small">Current password</label>
                                            <input type="password" id="pwdCurrent" class="form-control" autocomplete="current-password" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small">New password</label>
                                            <input type="password" id="pwdNew" class="form-control" autocomplete="new-password" required>
                                            <div class="form-text">At least 8 characters, with a number and a letter.</div>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small">Confirm new password</label>
                                            <input type="password" id="pwdConfirm" class="form-control" autocomplete="new-password" required>
                                        </div>
                                        <div class="col-12 d-grid">
                                            <button class="btn btn-outline-secondary" type="submit"><i class="fa-solid fa-key me-1"></i>Update password
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Toast anchor -->
                    <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
                        <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body" id="toastMsg">Saved!</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <!-- Vendor JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
        <!-- Common app includes -->
        <script src="js/dt-include.js"></script>
        <script src="js/sidebar.js" defer></script>
        <script src="js/app-user.js" defer></script>
        <script>
    (function(){
      // ===== Config =====
      const UPLOAD_URL = window.UPLOAD_URL || 'http://localhost:3000/api/upload';

      // ===== Session helpers =====
      function getSession(){ try { return JSON.parse(sessionStorage.getItem('dt_session') || 'null'); } catch { return null; } }
      function setSession(s){ try { sessionStorage.setItem('dt_session', JSON.stringify(s)); } catch {} }

      // ===== Toast =====
      const toastEl = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      const toast = new bootstrap.Toast(toastEl, { delay: 1800 });
      function showToast(msg, ok=true){
        toastEl.classList.toggle('text-bg-danger', !ok);
        toastEl.classList.toggle('text-bg-success', ok);
        toastMsg.textContent = msg;
        toast.show();
      }

      // ===== Populate account fields =====
      function fillAccount(){
        const sess = getSession() || { user:{} };
        const u = sess.user || {};
        document.getElementById('avatarPreview').src = u.avatar || 'images/DataTech.png';
        document.getElementById('accName').value  = u.name  || '';
        document.getElementById('accEmail').value = u.email || '';
        document.getElementById('accRole').value  = u.role  || '—';
      }

      // ===== Account save (updates local session only) =====
      document.getElementById('accountForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name  = document.getElementById('accName').value.trim();
        const email = document.getElementById('accEmail').value.trim();
        if (!name || !email){ showToast('Please fill name and email.', false); return; }

        const sess = getSession() || { user:{} };
        sess.user = sess.user || {};
        sess.user.name = name;
        sess.user.email = email;
        setSession(sess);
        showToast('Account updated');
      });

      // ===== Password change (front-end only) =====
      document.getElementById('pwdForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const cur = document.getElementById('pwdCurrent').value;
        const p1  = document.getElementById('pwdNew').value;
        const p2  = document.getElementById('pwdConfirm').value;

        // simple rules
        const strong = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
        if (!strong.test(p1)){ showToast('Password must be 8+ chars and include letters & numbers.', false); return; }
        if (p1 !== p2){ showToast('Passwords do not match.', false); return; }
        if (!cur){ showToast('Enter your current password.', false); return; }

        // Here you would call your backend API.
        // fetch('/api/change-password', { method:'POST', body: JSON.stringify({cur, p1}), headers:{'Content-Type':'application/json'} })
        //   .then(...)

        // Demo: success
        (e.target).reset();
        showToast('Password updated');
      });

      // ===== Cropper wiring =====
      const input = document.getElementById('fileInput');
      const imgEl = document.getElementById('cropImage');
      let cropper = null;

      input.addEventListener('change', () => {
        const file = input.files && input.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        imgEl.src = url;
        imgEl.onload = () => {
          cropper?.destroy();
          cropper = new Cropper(imgEl, {
            viewMode: 1,
            aspectRatio: 1,
            dragMode: 'move',
            autoCropArea: 0.9,
            background: false,
            movable: true,
            zoomable: true,
            rotatable: true,
            responsive: true,
          });
        };
      });

      document.getElementById('zoomIn').addEventListener('click', ()=> cropper?.zoom(0.1));
      document.getElementById('zoomOut').addEventListener('click', ()=> cropper?.zoom(-0.1));
      document.getElementById('rotateL').addEventListener('click', ()=> cropper?.rotate(-10));
      document.getElementById('rotateR').addEventListener('click', ()=> cropper?.rotate(10));
      document.getElementById('reset').addEventListener('click', ()=> cropper?.reset());

      // Upload
      document.getElementById('upload').addEventListener('click', async ()=>{
        if (!cropper){ showToast('Choose a photo first.', false); return; }
        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512 });
        if (!canvas){ showToast('Could not crop this image.', false); return; }

        canvas.toBlob(async (blob)=>{
          if (!blob){ showToast('Failed to prepare image.', false); return; }

          const fd = new FormData();
          fd.append('profilePhoto', blob, 'avatar.png');

          const btn = document.getElementById('upload');
          const old = btn.innerHTML;
          btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Uploading';

          try{
            const res = await fetch(UPLOAD_URL, { method:'POST', body: fd });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Upload failed');

            // Preview + session
            document.getElementById('avatarPreview').src = data.url;
            const sess = getSession() || { user:{} };
            sess.user = sess.user || {};
            sess.user.avatar = data.url;
            setSession(sess);

            showToast('Avatar updated');
          }catch(err){
            console.error(err);
            showToast(err.message || 'Upload failed', false);
          }finally{
            btn.disabled = false; btn.innerHTML = old;
          }
        }, 'image/png', 0.92);
      });

      // Init
      fillAccount();
    })();
  </script>
    </body>
</html>