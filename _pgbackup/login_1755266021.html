<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Login · Loyalty Console</title>
        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="images/datatech-ico.ico">
        <!-- Inter + Bootstrap -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
    :root{
      --dt-bg:#f3f5f9; --dt-card:#ffffff; --dt-text:#0f172a; --dt-muted:#6b7280;
      --dt-primary:#1f6feb; --dt-border:#e5e7eb; --dt-radius-lg:16px; --dt-shadow:0 12px 30px rgba(15,23,42,.08);
    }
    html,body{height:100%}
    body{
      background:var(--dt-bg); color:var(--dt-text);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:grid; place-items:center; padding:20px;
    }
    .auth-wrap{ width:100%; max-width:420px; }
    .auth-card{
      background:var(--dt-card); border:1px solid var(--dt-border); border-radius:var(--dt-radius-lg);
      box-shadow:var(--dt-shadow); padding:22px;
    }
    .brand{ display:flex; align-items:center; gap:.65rem; font-weight:700; margin-bottom:14px; }
    .brand img{ width:28px; height:28px; border-radius:8px; }
    .muted{ color:var(--dt-muted); }
    .btn{ border-radius:12px; }
    .btn-primary{
      --bs-btn-bg: var(--dt-primary); --bs-btn-border-color: var(--dt-primary);
      --bs-btn-hover-bg:#1b5ed1; --bs-btn-hover-border-color:#1b5ed1;
      --bs-btn-active-bg:#184fb3; --bs-btn-active-border-color:#184fb3;
      --bs-btn-shadow:0 8px 18px rgba(31,111,235,.25);
    }
    .form-control{ border-radius:12px; }
    .help{
      border:1px dashed #c7d2fe; background:#eef2ff; color:#1e3a8a; border-radius:12px; padding:10px 12px; font-size:.9rem;
    }
  </style>
    </head>
    <body>
        <div class="auth-wrap">
            <div class="brand">
                <img src="images/DataTech.png" alt="DataTech">
                <span>Loyalty Console</span>
            </div>
            <div class="auth-card">
                <h1 class="h5 fw-bold mb-1">Sign in</h1>
                <div class="muted small mb-3">Enter your company, username, and password.</div>
                <form id="loginForm" class="needs-validation" novalidate>
                    <div class="mb-2">
                        <label class="form-label small">Company</label>
                        <input id="company" class="form-control" required placeholder="e.g., Koobs Cafe">
                        <div class="invalid-feedback">Company is required.</div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Username</label>
                        <input id="username" class="form-control" required placeholder="e.g., reem or reem@koobs.cafe">
                        <div class="invalid-feedback">Username is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Password</label>
                        <input id="password" type="password" class="form-control" minlength="6" required placeholder="••••••••">
                        <div class="invalid-feedback">Minimum 6 characters.</div>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary" type="submit">Sign In</button>
                    </div>
                </form>
                <div class="mt-2 small">
                    No test account? <a href="dev-login.html">Use the demo login</a>.
                </div>
            </div>
        </div>
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Optional: user chip script (won’t show on login but harmless to include) -->
        <script src="js/app-user.js"></script>
        <script>
    (function(){
      const KEY_SESSION='RBAC_SESSION', KEY_USER='RBAC_USER', KEY_COMPANY='DT_COMPANY';

      // If already logged in, go to dashboard
      try{
        const hasSession = !!JSON.parse(localStorage.getItem(KEY_SESSION)||'null');
        if (hasSession){ location.replace('dashboard.html'); return; }
      }catch(_){}

      const loginForm = document.getElementById('loginForm');
      const companyEl = document.getElementById('company');
      const userEl    = document.getElementById('username');
      const passEl    = document.getElementById('password');

      loginForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        loginForm.classList.add('was-validated');
        if (!loginForm.checkValidity()) return;

        const companyName = companyEl.value.trim();
        const username    = userEl.value.trim();
        const password    = passEl.value; // In demo we don't verify. In prod: call your API.

        // Build email if user typed plain username
        const email = username.includes('@') ? username : (username + '@' + companyName.replace(/\s+/g,'').toLowerCase() + '.local');

        // Create demo session + user profile
        const session = {
          userId: 'usr_' + Math.random().toString(36).slice(2,10),
          companyId: 'cmp_' + companyName.toLowerCase().replace(/\s+/g,'-'),
          email, role:'admin', issuedAt: Date.now()
        };
        const userProfile = {
          name: username.replace(/\./g,' ').replace(/(^|\s)\S/g, s=>s.toUpperCase()),
          email,
          photoUrl: '' // keep empty to show initials; update later in Settings
        };

        try{
          localStorage.setItem(KEY_SESSION, JSON.stringify(session));
          localStorage.setItem(KEY_USER, JSON.stringify(userProfile));
          localStorage.setItem(KEY_COMPANY, JSON.stringify({ id: session.companyId, name: companyName }));
        }catch(err){
          alert('Could not save session: ' + err.message);
          return;
        }

        // Redirect
        const redirectAfter = sessionStorage.getItem('redirectAfterLogin') || 'dashboard.html';
        location.replace(redirectAfter);
      });
    })();
  </script>
    </body>
</html>