<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>System Logs · Loyalty Console</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
        <link rel="icon" type="image/x-icon" href="images/datatech-ico.ico">
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/sidebar.css">
        <style>
    .badge-log { font-weight:700; }
    .badge-log.INFO  { background:#e7f5ff; color:#0b6aa6; border:1px solid #b5e1ff; }
    .badge-log.WARN  { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
    .badge-log.ERROR { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .badge-log.DEBUG { background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .log-meta { max-width: 420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .control-inline > * { margin-right:.5rem; }
    .control-inline .form-control, .control-inline .form-select { width:auto; }
    .sticky-controls { position:sticky; top:64px; z-index:10; background:var(--dt-bg,#f3f5f9); padding:.5rem .5rem 0; }
    .table thead th { white-space:nowrap; }
  </style>
    </head>
    <body class="fullpage">
        <div class="layout">
            <aside class="sidebar" id="sidebar" data-include="partials/sidebar.html"></aside>
            <div class="main">
                <div data-include="partials/topbar.html"></div>
                <main class="page">
                    <div class="container-narrow">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <h1 class="h5 fw-bold mb-0">System Logs</h1>
                                <div class="text-muted small">Live app events, warnings, and errors</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="btnExport" class="btn btn-outline-secondary btn-sm">
                                    <i class="fa-solid fa-file-arrow-down me-1"></i>Export
                                </button>
                                <button id="btnClear" class="btn btn-outline-secondary btn-sm">
                                    <i class="fa-regular fa-trash-can me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                        <div class="dt-card p-card sticky-controls">
                            <div class="row g-2 align-items-end">
                                <div class="col-12 col-md-auto">
                                    <label class="form-label small">Search</label>
                                    <input id="q" type="text" class="form-control" placeholder="message, page, meta…">
                                </div>
                                <div class="col-6 col-md-auto">
                                    <label class="form-label small">Level</label>
                                    <select id="level" class="form-select">
                                        <option value="">All</option>
                                        <option>INFO</option>
                                        <option>WARN</option>
                                        <option>ERROR</option>
                                        <option>DEBUG</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md-auto">
                                    <label class="form-label small">Page</label>
                                    <input id="page" type="text" class="form-control" placeholder="e.g. Orders">
                                </div>
                                <div class="col-6 col-md-auto">
                                    <label class="form-label small">From</label>
                                    <input id="from" type="datetime-local" class="form-control">
                                </div>
                                <div class="col-6 col-md-auto">
                                    <label class="form-label small">To</label>
                                    <input id="to" type="datetime-local" class="form-control">
                                </div>
                                <div class="col-12 col-md-auto">
                                    <label class="form-label small">&nbsp;</label>
                                    <div>
                                        <button id="btnApply" class="btn btn-primary btn-sm me-1">
                                            <i class="fa-solid fa-filter me-1"></i>Filter
                                        </button>
                                        <button id="btnReset" class="btn btn-outline-secondary btn-sm">
                                            <i class="fa-solid fa-rotate me-1"></i>Reset
                                        </button>
                                        <div class="form-check form-check-inline ms-2">
                                            <input id="tail" class="form-check-input" type="checkbox">
                                            <label class="form-check-label small" for="tail">Live tail</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="dt-card p-card mt-2">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:210px">Timestamp</th>
                                            <th style="width:110px">Level</th>
                                            <th style="width:220px">Page</th>
                                            <th>Message</th>
                                            <th style="width:440px">Meta</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/dt-include.js"></script>
        <script src="js/sidebar.js" defer></script>
        <script src="js/app-user.js" defer></script>
        <script src="js/log.js"></script>
        <script>
    (function () {
      const els = {
        q:      document.getElementById('q'),
        level:  document.getElementById('level'),
        page:   document.getElementById('page'),
        from:   document.getElementById('from'),
        to:     document.getElementById('to'),
        tail:   document.getElementById('tail'),
        body:   document.getElementById('logBody'),
        apply:  document.getElementById('btnApply'),
        reset:  document.getElementById('btnReset'),
        clear:  document.getElementById('btnClear'),
        export: document.getElementById('btnExport'),
      };

      function badge(level) {
        const lv = (level||'').toUpperCase();
        return `<span class="badge badge-log ${lv}">${lv||'INFO'}</span>`;
      }
      function fmtTS(iso) {
        try {
          const d = new Date(iso);
          return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
        } catch { return iso; }
      }
      function fmtMeta(meta) {
        if (meta == null) return '';
        if (typeof meta === 'string') return meta;
        try { return JSON.stringify(meta); } catch { return String(meta); }
      }

      function currentFilter() {
        return {
          q: els.q.value,
          level: els.level.value,
          page: els.page.value,
          from: els.from.value ? new Date(els.from.value).toISOString() : '',
          to:   els.to.value   ? new Date(els.to.value).toISOString()   : ''
        };
      }

      function render() {
        const rows = (window.Log?.filter(currentFilter()) || []).reverse(); // newest first
        els.body.innerHTML = rows.map(r => `
          <tr class="mono">
            <td>${fmtTS(r.ts)}</td>
            <td>${badge(r.level)}</td>
            <td>${r.page||'—'}</td>
            <td>${(r.msg||'').replace(/</g,'&lt;')}</td>
            <td class="log-meta" title="${fmtMeta(r.meta)}">${fmtMeta(r.meta)}</td>
          </tr>
        `).join('');
        if (els.tail.checked) {
          try { els.body.parentElement.parentElement.scrollTo({ top: 999999 }); } catch {}
        }
      }

      // Wire controls
      els.apply.addEventListener('click', render);
      els.reset.addEventListener('click', () => {
        els.q.value = els.level.value = els.page.value = els.from.value = els.to.value = '';
        render();
      });
      els.clear.addEventListener('click', () => { window.Log?.clear(); render(); });
      els.export.addEventListener('click', () => {
        const rows = window.Log?.filter(currentFilter()) || [];
        window.Log?.exportCSV(rows);
      });

      // Live updates from other tabs / pages
      window.addEventListener('storage', (e) => { if (e.key === 'dt_logs') render(); });
      window.addEventListener('dt:logs:updated', render);

      // First paint
      render();

      // Generate a couple of demo rows if empty
      const have = (window.Log?.all() || []).length;
      if (!have) {
        Log.info('Logs initialized', { page:'System Logs', meta:location.pathname });
        Log.warn('Example warning', { page:'System Logs' });
        Log.error('Example error (demo)', { page:'System Logs', meta:{ code:'E-DEMO' } });
        render();
      }
    })();
  </script>
    </body>
</html>